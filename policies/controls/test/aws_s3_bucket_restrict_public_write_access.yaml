ID: aws_s3_bucket_restrict_public_write_access
Title: S3 buckets should prohibit public write access
Description: Manage access to resources in the AWS Cloud by only allowing authorized
  users, processes, and devices access to AWS Simple Storage Service (AWS S3) buckets.
Query:
  Engine: odysseus-v0.0.1
  QueryToExecute: "    with public_acl as (\n      select\n        distinct name\n
    \     from\n        aws_s3_bucket,\n        jsonb_array_elements(acl -> 'Grants')
    as grants\n      where\n        (grants -> 'Grantee' ->> 'URI' = 'http://acs.amazonaws.com/groups/global/AllUsers'\n
    \       or grants -> 'Grantee' ->> 'URI' = 'http://acs.amazonaws.com/groups/global/AuthenticatedUsers')\n
    \       and (\n          grants ->> 'Permission' = 'FULL_CONTROL'\n          or
    grants ->> 'Permission' = 'WRITE_ACP'\n          or grants ->> 'Permission' =
    'WRITE'\n        )\n    ), write_access_policy as (\n        select\n          distinct
    name\n        from\n          aws_s3_bucket,\n          jsonb_array_elements(policy_std
    -> 'Statement') as s,\n          jsonb_array_elements_text(s -> 'Action') as action\n
    \       where\n          s ->> 'Effect' = 'Allow'\n          and (\n            s
    -> 'Principal' -> 'AWS' = '[\"*\"]'\n            or s ->> 'Principal' = '*'\n
    \         )\n          and (\n            action = '*'\n            or action
    = '*:*'\n            or action = 's3:*'\n            or action ilike 's3:put%'\n
    \           or action ilike 's3:delete%'\n            or action ilike 's3:create%'\n
    \           or action ilike 's3:update%'\n            or action ilike 's3:replicate%'\n
    \           or action ilike 's3:restore%'\n          )\n    )\n    select\n      b.arn
    as resource,\n      case\n        when (block_public_acls or a.name is null) and
    not bucket_policy_is_public then 'ok'\n        when (block_public_acls or a.name
    is null) and (bucket_policy_is_public and block_public_policy) then 'ok'\n        when
    bucket_policy_is_public and p.name is null then 'ok'\n        else 'alarm'\n      end
    status,\n      case\n        when (block_public_acls or a.name is null ) and not
    bucket_policy_is_public then b.title || ' not publicly writable.'\n        when
    (block_public_acls or a.name is null) and (bucket_policy_is_public and block_public_policy)
    then b.title || ' not publicly writable.'\n        when (block_public_acls or
    a.name is null) and (bucket_policy_is_public and p.name is null) then b.title
    || ' not publicly writable.'\n        else b.title || ' publicly writable.'\n
    \     end reason\n      \n      \n    from\n      aws_s3_bucket as b\n      left
    join public_acl as a on b.name = a.name\n      left join write_access_policy as
    p on b.name = p.name;\n"
  Connector:
  - aws
  PrimaryTable: ""
  ListOfTables: []
  Parameters: []
  Global: false
Tags: {}
Severity: ""
