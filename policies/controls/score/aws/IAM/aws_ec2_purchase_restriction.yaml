ID: aws_ec2_purchase_restriction
Title: "Amazon EC2 Purchase Restriction"
Description: "Restrict unintended IAM users from purchasing Amazon EC2 Reserved Instances and/or Savings Plans."
Query:
    Engine: odysseus-v0.0.1
    ListOfTables:
        - aws_iam_policy
        - aws_iam_user
    Parameters: []
    PrimaryTable: aws_iam_user
    QueryToExecute: "WITH too_permissive_policies AS (\n  SELECT\n    arn\n  FROM\n    aws_iam_policy,\n    jsonb_array_elements(policy_std -> 'Statement') AS s,\n    jsonb_array_elements_text(s -> 'Action') AS action\n  WHERE\n    action IN ('ec2:PurchaseReservedInstancesOffering', 'savingsplans:CreateSavingsPlan')\n)\n\nSELECT\n  name AS resource,\n  kaytu_account_id,\n  kaytu_resource_id,\n  CASE\n    WHEN EXISTS(\n      select 1 from jsonb_array_elements_text(attached_policy_arns) as parn\n        LEFT JOIN too_permissive_policies AS tp ON parn = tp.arn where tp.arn is not null\n    ) and '{{.awsAllowedUsersPurchaseEc2}}' not like '%' || name || '%' THEN 'alarm'\n    WHEN EXISTS(\n      SELECT 1 \n      FROM jsonb_array_elements(inline_policies_std) AS p, jsonb_array_elements(p -> 'PolicyDocument' -> 'Statement') AS s,\n        jsonb_array_elements_text(s -> 'Action') AS action\n      WHERE\n        action IN ('ec2:PurchaseReservedInstancesOffering', 'savingsplans:CreateSavingsPlan')\n        AND s ->> 'Effect' = 'Allow'\n    ) and '{{.awsAllowedUsersPurchaseEc2}}' not like '%' || name || '%' THEN 'alarm'\n    ELSE 'ok'\n  END AS status,\n  CASE\n    WHEN EXISTS(\n      select 1 from jsonb_array_elements_text(attached_policy_arns) as parn\n        LEFT JOIN too_permissive_policies AS tp ON parn = tp.arn where tp.arn is not null\n    ) and '{{.awsAllowedUsersPurchaseEc2}}' not like '%' || name || '%' THEN 'User has access to purchase ec2 but is not in your organization allowed list'\n    WHEN EXISTS(\n      SELECT 1 \n      FROM jsonb_array_elements(inline_policies_std) AS p, jsonb_array_elements(p -> 'PolicyDocument' -> 'Statement') AS s,\n        jsonb_array_elements_text(s -> 'Action') AS action\n      WHERE\n        action IN ('ec2:PurchaseReservedInstancesOffering', 'savingsplans:CreateSavingsPlan')\n        AND s ->> 'Effect' = 'Allow'\n    ) and '{{.awsAllowedUsersPurchaseEc2}}' not like '%' || name || '%' THEN 'User has access to purchase ec2 but is not in your organization allowed list'\n    ELSE 'User either not have the access to purchase ec2 or is in the allowed list'\n  END AS reason,\n  region, \n  account_id\nFROM\n  aws_iam_user\n"
Severity: medium
Tags:
    score_service_name:
        - AWS Identity and Access Management (IAM)
Connector:
    - AWS
