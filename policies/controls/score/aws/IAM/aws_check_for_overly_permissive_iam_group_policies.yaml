ID: aws_check_for_overly_permissive_iam_group_policies
Title: "Check for Overly Permissive IAM Group Policies"
Description: "Ensure that Amazon IAM policies attached to IAM groups aren't too permissive."
Query:
    Engine: odysseus-v0.0.1
    ListOfTables:
        - aws_iam_group
        - aws_iam_policy
    Parameters: []
    PrimaryTable: aws_iam_group
    QueryToExecute: "WITH too_permissive_policies AS (\n  SELECT\n    arn\n  FROM\n    aws_iam_policy,\n    jsonb_array_elements(policy_std -> 'Statement') AS s,\n    jsonb_array_elements_text(s -> 'Action') AS action\n  WHERE\n    action IN ('*', '*:*')\n    AND s ->> 'Effect' = 'Allow'\n)\n\nSELECT\n  name AS resource,\n  kaytu_account_id,\n  kaytu_resource_id,\n  CASE\n    WHEN EXISTS(\n      select 1 from jsonb_array_elements_text(attached_policy_arns) as parn\n        LEFT JOIN too_permissive_policies AS tp ON parn = tp.arn where tp.arn is not null\n    ) THEN 'alarm'\n    WHEN EXISTS(\n      SELECT 1 \n      FROM jsonb_array_elements(inline_policies_std) AS p, jsonb_array_elements(p -> 'PolicyDocument' -> 'Statement') AS s,\n        jsonb_array_elements_text(s -> 'Action') AS action\n      WHERE\n        action IN ('*', '*:*')\n        AND s ->> 'Effect' = 'Allow'\n    ) THEN 'alarm'\n    ELSE 'ok'\n  END AS status,\n  CASE\n    WHEN EXISTS(\n      select 1 from jsonb_array_elements_text(attached_policy_arns) as parn\n        LEFT JOIN too_permissive_policies AS tp ON parn = tp.arn where tp.arn is not null\n    ) THEN ' there is too permissive attached policy'\n    WHEN EXISTS(\n      SELECT 1 \n      FROM jsonb_array_elements(inline_policies_std) AS p, jsonb_array_elements(p -> 'PolicyDocument' -> 'Statement') AS s,\n        jsonb_array_elements_text(s -> 'Action') AS action\n      WHERE\n        action IN ('*', '*:*')\n        AND s ->> 'Effect' = 'Allow'\n    ) THEN ' there is too permissive inline policy'\n    ELSE 'there is no too permissive policy'\n  END AS reason,\n  region, \n  account_id\nFROM\n  aws_iam_group AS g\n"
Severity: medium
Tags:
    score_service_name:
        - AWS Identity and Access Management (IAM)
    score_tags:
        - Problem Identities
Connector:
    - AWS
