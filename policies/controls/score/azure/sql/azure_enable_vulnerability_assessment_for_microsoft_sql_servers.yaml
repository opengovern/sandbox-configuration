ID: azure_enable_vulnerability_assessment_for_microsoft_sql_servers
Title: "Enable Vulnerability Assessment for Microsoft SQL Servers"
Description: "Ensure that Vulnerability Assessment is enabled for Microsoft SQL database servers."
Query:
    Engine: odysseus-v0.0.1
    ListOfTables:
        - azure_sql_server
        - azure_subscription
    Parameters: []
    PrimaryTable: azure_sql_server
    QueryToExecute: |
        with sql_server_va as (
          select
            distinct id
          from
            azure_sql_server as s,
            jsonb_array_elements(server_vulnerability_assessment) as va
          where
            va -> 'properties' -> 'storageContainerPath' is not null
        )
        select
          name as resource,
          s.kaytu_resource_id,
          s.kaytu_account_id,
          case
            when v.id is not null then 'ok'
            else 'alarm'
          end as status,
          case
            when v.id is not null then 'Vulnerability Assessment  is enabled'
            else 'Vulnerability Assessment Recurring is not enabled'
          end as reason
        from
          azure_sql_server as s
          left join azure_subscription as sub on s.subscription_id = sub.subscription_id
          left join sql_server_va as v on lower(s.id) = lower(v.id)
Severity: medium
Tags:
    score_service_name:
        - Azure Managed SQL Service
    score_tags:
        - Problem Identities
Connector:
    - Azure
