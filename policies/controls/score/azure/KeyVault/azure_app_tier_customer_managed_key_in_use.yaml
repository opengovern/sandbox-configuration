ID: azure_app_tier_customer_managed_key_in_use
Title: "App Tier Customer-Managed Key In Use"
Description: "Ensure that a Customer-Managed Key is created for your Azure cloud application tier."
Query:
    Engine: odysseus-v0.0.1
    ListOfTables:
        - azure_key_vault_key
        - azure_subscription
    Parameters:
        - Key: azureAppTierTags
          Required: true
    PrimaryTable: azure_subscription
    QueryToExecute: |
        select
          display_name as resource,
          sub.kaytu_resource_id,
          sub.kaytu_account_id,
          case
            when exists(
              select 1 from azure_key_vault_key as k where (k.subscription_id = sub.subscription_id) and
                k.tags is not null and
                (k.tags::text like '%' || REPLACE(REPLACE((
                  SELECT jsonb_object_agg(key, value)::text
                  FROM jsonb_each_text('{{.azureAppTierTags}}'::jsonb)
                ), '{', ''), '}', '') || '%') and enabled
            ) then 'ok'
            else 'alarm'
          end as status,
          case
            when exists(
              select 1 from azure_key_vault_key as k where (k.subscription_id = sub.subscription_id) and
                k.tags is not null and
                (k.tags::text like '%' || REPLACE(REPLACE((
                  SELECT jsonb_object_agg(key, value)::text
                  FROM jsonb_each_text('{{.azureAppTierTags}}'::jsonb)
                ), '{', ''), '}', '') || '%') and enabled
            ) then 'subscription has an app-tier cmk'
            else 'subscription does not have any app-tier cmk'
          end as reason,
          sub.display_name as subscription
        from
          azure_subscription as sub
Severity: high
Tags:
    score_service_name:
        - Azure KeyVault
    score_tags:
        - Unencrypted Storage
Connector:
    - Azure
