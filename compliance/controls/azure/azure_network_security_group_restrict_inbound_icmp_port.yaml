Description: Network security group provides stateful filtering of inbound/outbound network traffic to Azure resources. It is recommended that no network security group allows unrestricted inbound access to ICMP port.
ID: azure_network_security_group_restrict_inbound_icmp_port
IntegrationType:
  - azure_subscription
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - azure_network_security_group
    - azure_subscription
  Parameters: []
  PrimaryTable: azure_network_security_group
  QueryToExecute: |
    WITH unrestricted_inbound AS (
      SELECT
        DISTINCT name AS sg_name
      FROM
        azure_network_security_group nsg,
        jsonb_array_elements(security_rules || default_security_rules) AS sg,
        jsonb_array_elements_text(
          CASE
            WHEN jsonb_array_length(sg -> 'properties' -> 'destinationPortRanges') > 0 THEN (sg -> 'properties' -> 'destinationPortRanges')
            ELSE jsonb_build_array(sg -> 'properties' -> 'destinationPortRange')
          END
        ) AS dport,
        jsonb_array_elements_text(
          CASE
            WHEN jsonb_array_length(sg -> 'properties' -> 'sourceAddressPrefixes') > 0 THEN (sg -> 'properties' -> 'sourceAddressPrefixes')
            ELSE jsonb_build_array(sg -> 'properties' -> 'sourceAddressPrefix')
          END
        ) AS sip
      WHERE
        sg -> 'properties' ->> 'access' = 'Allow'
        AND sg -> 'properties' ->> 'direction' = 'Inbound'
        AND (sg -> 'properties' ->> 'protocol' ILIKE 'ICMP' OR sg -> 'properties' ->> 'protocol' = '*')
        AND sip IN ('*', '0.0.0.0', '0.0.0.0/0', 'Internet', 'any', '<nw>/0', '/0')
        AND (
          dport = '*'
          OR (
            dport LIKE '%-%'
            AND (
              split_part(dport, '-', 1) :: integer = 0
              AND split_part(dport, '-', 2) :: integer = 65535
            )
          )
        )
    )
    SELECT
      sg.id AS resource,
      sg.platform_account_id AS platform_account_id,
      sg.platform_resource_id AS platform_resource_id,
      CASE
        WHEN nsg.sg_name IS NULL THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN nsg.sg_name IS NULL THEN sg.title || ' restricts ICMP access from internet.'
        ELSE sg.title || ' allows ICMP access from internet.'
      END AS reason
    FROM
      azure_network_security_group sg
      LEFT JOIN unrestricted_inbound nsg ON nsg.sg_name = sg.name
      JOIN azure_subscription sub ON sub.subscription_id = sg.subscription_id;
Severity: low
Tags: {}
Title: Network security groups should restrict inbound ICMP port access from internet