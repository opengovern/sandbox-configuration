Description: This policy denies if a gateway subnet is configured with a network security group. Assigning a network security group to a gateway subnet will cause the gateway to stop functioning.
ID: azure_network_security_group_subnet_associated
IntegrationType:
  - azure_subscription
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - azure_network_security_group
    - azure_subscription
  Parameters: []
  PrimaryTable: azure_network_security_group
  QueryToExecute: |
    SELECT
      sg.id AS resource,
      sg.platform_account_id AS platform_account_id,
      sg.platform_resource_id AS platform_resource_id,
      CASE
        WHEN subnets IS NULL THEN 'alarm'
        ELSE 'ok'
      END AS status,
      CASE
        WHEN subnets IS NULL THEN name || ' not associated with subnet.'
        ELSE name || ' associated with ' || SPLIT_PART(RTRIM((subnet -> 'id')::TEXT, '\"'), '/subnets/', 2) || '.'
      END AS reason,
      sg.resource_group AS resource_group,
      sub.display_name AS subscription
    FROM
      azure_network_security_group AS sg
    JOIN azure_subscription AS sub ON sub.subscription_id = sg.subscription_id
    LEFT JOIN JSONB_ARRAY_ELEMENTS(subnets) AS subnet ON TRUE;
Severity: high
Tags:
  hipaa_hitrust_v92:
    - "true"
  nist_sp_800_53_rev_5:
    - "true"
  service:
    - Azure/Network
Title: Subnets should be associated with a Network Security Group