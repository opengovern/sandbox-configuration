Description: Amazon S3 buckets can contain sensitive data, that for security purposes should be discovered, monitored, classified, and protected. Macie, along with other 3rd party tools, can automatically provide an inventory of Amazon S3 buckets.
ID: aws_cis_v200_2_1_3
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - aws_macie2_classification_job
    - aws_s3_bucket
  Parameters: []
  PrimaryTable: aws_s3_bucket
  QueryToExecute: |
    WITH bucket_list AS (
      SELECT
        TRIM(b::text, '"' ) AS bucket_name
      FROM
        aws_macie2_classification_job,
        jsonb_array_elements(s3_job_definition -> 'BucketDefinitions') AS d,
        jsonb_array_elements(d -> 'Buckets') AS b
    )
    SELECT
      b.arn AS resource,
      b.platform_account_id AS platform_account_id,
      b.platform_resource_id AS platform_resource_id,
      CASE
        WHEN b.region = ANY(ARRAY['us-gov-east-1', 'us-gov-west-1']) THEN 'skip'
        WHEN l.bucket_name IS NOT NULL THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN b.region = ANY(ARRAY['us-gov-east-1', 'us-gov-west-1']) THEN b.title || ' not protected by Macie as Macie is not supported in ' || b.region || '.'
        WHEN l.bucket_name IS NOT NULL THEN b.title || ' protected by Macie.'
        ELSE b.title || ' not protected by Macie.'
      END AS reason
    FROM
      aws_s3_bucket AS b
      LEFT JOIN bucket_list AS l ON b.name = l.bucket_name;
Severity: low
Tags: {}
Title: 2.1.3 Ensure all data in Amazon S3 has been discovered, classified, and secured when required