Description: Real-time monitoring of API calls can be achieved by directing CloudTrail Logs to CloudWatch Logs and establishing corresponding metric filters and alarms. Routing tables are used to route network traffic between subnets and to network gateways. It is recommended that a metric filter and alarm be established for changes to route tables.
ID: aws_cis_v130_4_13
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - aws_cloudtrail_trail
    - aws_cloudwatch_alarm
    - aws_sns_topic_subscription
    - aws_cloudwatch_log_metric_filter
    - aws_account
  Parameters: []
  PrimaryTable: aws_cloudtrail_trail
  QueryToExecute: |
    WITH trails AS (
      SELECT
        trail.account_id,
        trail.name AS trail_name,
        trail.is_logging,
        split_part(trail.log_group_arn, ':', 7) AS log_group_name
      FROM
        aws_cloudtrail_trail AS trail,
        jsonb_array_elements(trail.event_selectors) AS se
      WHERE
        trail.is_multi_region_trail IS TRUE
        AND trail.is_logging
        AND se ->> 'ReadWriteType' = 'All'
        AND trail.log_group_arn IS NOT NULL
      ORDER BY
        trail_name
    ),
    alarms AS (
      SELECT
        metric_name,
        action_arn AS topic_arn
      FROM
        aws_cloudwatch_alarm,
        jsonb_array_elements_text(aws_cloudwatch_alarm.alarm_actions) AS action_arn
      ORDER BY
        metric_name
    ),
    topic_subscriptions AS (
      SELECT
        subscription_arn,
        topic_arn
      FROM
        aws_sns_topic_subscription
      ORDER BY
        subscription_arn
    ),
    metric_filters AS (
      SELECT
        filter.name AS filter_name,
        filter_pattern,
        log_group_name,
        metric_transformation_name
      FROM
        aws_cloudwatch_log_metric_filter AS filter
      WHERE
        filter.filter_pattern ~ '\s*\$\.eventName\s*=\s*CreateRoute\s+'
        || filter.filter_pattern ~ '\$\.eventName\s*=\s*CreateRouteTable\s+'
        || filter.filter_pattern ~ '\$\.eventName\s*=\s*ReplaceRoute\s+'
        || filter.filter_pattern ~ '\$\.eventName\s*=\s*ReplaceRouteTableAssociation\s+'
        || filter.filter_pattern ~ '\$\.eventName\s*=\s*DeleteRouteTable\s+'
        || filter.filter_pattern ~ '\$\.eventName\s*=\s*DeleteRoute\s+'
        || filter.filter_pattern ~ '\$\.eventName\s*=\s*DisassociateRouteTable'
      ORDER BY
        filter_name
    ),
    filter_data AS (
      SELECT
        t.account_id,
        t.trail_name,
        f.filter_name
      FROM
        trails AS t
      JOIN
        metric_filters AS f ON f.log_group_name = t.log_group_name
      JOIN
        alarms AS alarm ON alarm.metric_name = f.metric_transformation_name
      JOIN
        topic_subscriptions AS subscription ON subscription.topic_arn = alarm.topic_arn
    )
    SELECT
      DISTINCT 'arn:' || a.partition || ':::' || a.account_id AS resource,
      a.og_account_id AS og_account_id,
      a.og_resource_id AS og_resource_id,
      CASE
        WHEN f.trail_name IS NULL THEN 'alarm'
        ELSE 'ok'
      END AS status,
      CASE
        WHEN f.trail_name IS NULL THEN 'No log metric filter and alarm exist for route table changes.'
        ELSE filter_name || ' forwards events for route table changes.'
      END AS reason
    FROM
      aws_account AS a
      LEFT JOIN filter_data AS f ON a.account_id = f.account_id;
Severity: low
Tags: {}
Title: 4.13 Ensure a log metric filter and alarm exist for route table changes