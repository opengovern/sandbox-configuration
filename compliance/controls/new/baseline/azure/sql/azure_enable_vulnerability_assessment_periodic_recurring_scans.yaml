id: azure_enable_vulnerability_assessment_periodic_recurring_scans
title: Enable Vulnerability Assessment Periodic Recurring Scans
description: Ensure that the Vulnerability Assessment Periodic Recurring Scans setting is enabled for SQL database servers.
integration_type:
  - azure_subscription
parameters: []
policy:
    language: sql
    primary_resource: azure_sql_server
    definition: |
        WITH sql_server_va AS (
          SELECT
            DISTINCT id
          FROM
            azure_sql_server AS s,
            jsonb_array_elements(server_vulnerability_assessment) AS va
          WHERE
            va -> 'properties' -> 'recurringScans' ->> 'isEnabled' = 'true'
        )
        SELECT
          name AS resource,
          s.platform_resource_id,
          s.platform_integration_id,
          CASE
            WHEN v.id IS NOT NULL THEN 'ok'
            ELSE 'alarm'
          END AS status,
          CASE
            WHEN v.id IS NOT NULL THEN 'Vulnerability Assessment Recurring Scan is enabled'
            ELSE 'Vulnerability Assessment Recurring Scan is not enabled'
          END AS reason
        FROM
          azure_sql_server AS s
          LEFT JOIN azure_subscription AS sub ON s.subscription_id = sub.subscription_id
          LEFT JOIN sql_server_va AS v ON LOWER(s.id) = LOWER(v.id)
severity: medium
tags:
    platform_score_cloud_service_name:
      - Azure Managed SQL Service
    platform_score_use_case:
      - Problem Identities
    score_service_name:
      - Azure Managed SQL Service
    score_tags:
      - Problem Identities
